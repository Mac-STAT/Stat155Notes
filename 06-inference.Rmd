---
title: "Math 155 - Statistical Inference"
author: "Prof. Heggeseth"
date: "September 6, 2018"
output: 
  html_document: default
---

```{r setup6, echo=FALSE}
library(stringr)
library(infer)
library(nycflights13)
library(broom)
library(dplyr)
library(ggplot2)
library(stringr)
library(rvest)
library(mosaicData) 
library(ggmosaic)
library(NHANES)
library(mosaic)
knitr::opts_chunk$set(echo = TRUE)
```

#Statistical Inference

Let's remember our goal of "turning data into information." Based on a sample data set, we want to be able to say something about the larger population of interest. This is **statistical inference,** making inferences about the "truths" in sample and the larger population based a sample of data.

- To make causal inferences in the sample, we need to account for all possible confounding variables or we need to randomize the "treatment" and assure there are no other possible reasons for an observed effect.
- To generalize to a larger population, we need the sample to be representative of the larger population. Ideally, that sample would be randomly drawn from the population. If we actually have a census in that we have data on country, state, or county-level, then we can consider the observed data as a one realization of the underlying random process as the measurements will randomly vary with time. 

Let's do some statistical inference based on a random sample (SRS) of 100 flights leaving NYC in 2013. What is our population of interest? What population could we generalize to?

```{r}
flights <- flights %>% 
  na.omit() %>%
  mutate(season = case_when(
    month %in% c(10:12, 1:3) ~ "winter",
    month %in% c(4:9) ~ "summer"
  )) %>% 
  mutate(day_hour = case_when(
    between(hour, 1, 12) ~ "morning",
    between(hour, 13, 24) ~ "afternoon"
  )) %>% 
  select(arr_delay, dep_delay, season, 
         day_hour, origin, carrier)

set.seed(2018)
flights_samp <- flights %>%
  sample_n(size = 100)
```


We've already been thinking about random variation and how that plays a role in the conclusions we can draw. In this chapter, we will formalize two techniques that we use to do this inference: confidence intervals and hypothesis tests. 


##Confidence Intervals

A **confidence interval**  (also known as an interval estimate) is an interval of plausible values of the unknown population parameter of interest based on randomly sampled data. However, the interval computed from a particular sample does not necessarily include the true value of the parameter. Since the observed data are random samples from the population, the confidence interval obtained from the data is also random.

The **confidence level** represents the proportion of possible random samples and thus confidence intervals that contain the true value of the unknown population parameter. Typically, the confidence level is represented by $(1-\alpha/2)$ such that if $\alpha = 0.05$, then the confidence level is 95% or 0.95.


**Valid Interpretation:** I am 95% confident that my confidence interval of (lower, upper) contains the true population parameter (*put in context*), which means that we'd expect 95% of samples to lead to intervals that contain the tru population parameter value. 



###Via Bootstrapping

In order to gauge the sampling variability, we can treat our sample as our "fake population" and generate data from this population using the technique of bootstrapping.

Once we have a distribution of sample statistics based on the generated data sets, we'll create a confidence interval by finding the $\alpha/2$th percentile and the $(1-\alpha/2)$th percentile for our lower and upper bounds. 

####Proportion

Let's return to the flight data and estimate the proportion of morning flights based on a sample of 100 flights from NYC. 

```{r}
alpha <- 0.05

boot <- flights_samp %>%
   specify(response = day_hour, success = 'morning') %>%
   generate(reps = 1000, type = "bootstrap") %>%
   calculate(stat = "prop")

boot %>%
  summarize(lower = quantile(stat, alpha/2),
    upper = quantile(stat, 1-alpha/2))
```

Our bootstrap confidence interval gives a sense of the true proportion of flights departed NYC in the morning, keeping in mind that this sample could be one of the unlucky samples (the 5%) that have intervals that don't contain the true value.

####Mean and then Median

Perhaps you really care about the arrival delay time because you have somewhere important you need to be when you take flights out of NYC. Let's estimate the mean arrival delay based on a sample of 100 flights from NYC. 

```{r}
alpha <- 0.05

boot <- flights_samp %>%
   specify(response = arr_delay) %>%
   generate(reps = 1000, type = "bootstrap") %>%
   calculate(stat = "mean")

boot %>%
  summarize(lower = quantile(stat, alpha/2),
    upper = quantile(stat, 1-alpha/2))
```

Our bootstrap confidence interval gives potential values for of the true mean arrival delay for flights that departed NYC, keeping in mind that this sample could be one of the unlucky samples (the 5%) that have intervals that don't contain the true value. Also remember that the mean is sensitive to outliers...Let's try the median.

We get a slightly different story if we are interested in the middle number versus the average.

```{r}
alpha <- 0.05

boot <- flights_samp %>%
   specify(response = arr_delay) %>%
   generate(reps = 1000, type = "bootstrap") %>%
   calculate(stat = "median")

boot %>%
  summarize(lower = quantile(stat, alpha/2),
    upper = quantile(stat, 1-alpha/2))
```

####Difference in Proportions

Are the same relative numbers of morning flights in the winter and the summer? Let's see that our sample says.

```{r}
d_hat <- flights_samp %>% 
  group_by(season) %>% 
  summarize(prop = mean(day_hour == "morning")) %>%
  # Since summer - winter
  summarize(-diff(prop)) 
```

The observed difference in proportions is `r d_hat` using the sample of 100 flights.

```{r}
boot <- flights_samp %>%
  specify(day_hour ~ season, success = "morning") %>%
  generate(reps = 1000, type = "bootstrap") %>% 
  calculate(stat = "diff in props", order = c("summer", "winter"))

boot %>%
  summarize(lower = quantile(stat, alpha/2),
    upper = quantile(stat, 1-alpha/2))
```

Knowing that the sample is random, the interval estimate for the difference of proportions of flights that are morning flights between winter and summer is given by the bootstrap confidence interval. Is zero in the interval? If so, what does that tell you?

####Difference in Means

Everything says that there are more delays in winter. Is that actually true? 

```{r}
d_hat <- flights_samp %>% 
  group_by(season) %>% 
  summarize(mean_stat = mean(arr_delay)) %>% 
  # Want summer - winter
  summarize(-diff(mean_stat)) 
```

The observed difference in mean arrival delays is `r d_hat` using the sample of 100 flights.


```{r}
boot <- flights_samp %>%
   specify(arr_delay ~ season) %>%
   generate(reps = 1000, type = "bootstrap") %>%
   calculate(stat = "diff in means", order = c("summer", "winter")) 

boot %>%
  summarize(lower = quantile(stat, alpha/2),
    upper = quantile(stat, 1-alpha/2))
```

The 95% confidence interval gives a sense of the difference of mean arrival delays of flights between winter and summer is given by the bootstrap confidence interval. Is zero in the interval? If so, what does that tell you?


####Linear Model

How well can the departure delay predict the arrival delay? What is the effect of departing 1 more minute later? Does that correspond to 1 minute later in arrival on average? Let's look at the estimated slope between departure and arrival delays for the sample of 100 flights from NYC.

```{r}
slope_hat <- lm(arr_delay ~ dep_delay, data = flights_samp) %>% 
  broom::tidy() %>% 
  filter(term == "dep_delay") %>% 
  select(estimate)
```

The observed slope is `r slope_hat` using the sample of 100 flights.

```{r}
boot <- flights_samp %>%
   specify(arr_delay ~ dep_delay) %>% 
   generate(reps = 1000, type = "bootstrap") %>%
   calculate(stat = "slope")

boot %>%
  summarize(lower = quantile(stat, alpha/2),
    upper = quantile(stat, 1-alpha/2))
```

If the flight leaves an additional minute later, then we'd expect the arrival delay to be increased by a value in the interval above, on average. 


###Theory

In this day in age, we don't need mathematical theory to create confidence intervals. We just did it using Bootstrapping. 

However, if certain assumptions hold, then the mathematical theory proves to be just as accurate and less computationally intensive. Also, a good chunk of scientists "doing statistics" right now learned the theory because computers were powerful enough to consider techniques such as bootstrapping. You'll need to have an understand of what these techniques are to bridge the gap until all statistical inference is done using modern computational techniques.

####Proportion

Based on Binomial assumptions (independent draws, probability of success constant) and Normal approximation (n large enough)

```{r}
summary_prop <- flights_samp %>%
  summarize(p_hat = mean(day_hour == "morning"), n = n()) 

summary_prop %>%
  summarize(lower = p_hat - 2*sqrt(p_hat*(1-p_hat)/n),
    upper = p_hat + 2*sqrt(p_hat*(1-p_hat)/n))
```

####Mean

Based on independent draws, statistic = mean


```{r}
flights_samp %>%
  infer::t_test(arr_delay ~ NULL) 
```


####Difference in Proportions

Based on Binomial assumptions (independent draws, probability of success constant) and populations are independent


```{r}
d_hat <- flights_samp %>% 
  group_by(season) %>% 
  summarize(prop = mean(day_hour == "morning")) %>%
  # Since summer - winter
  summarize(-diff(prop)) 

```


####Difference in Means

Based on independent draws, statistic = mean, and population are independent


```{r}
flights_samp %>%
  mutate(season = factor(season)) %>%
  infer::t_test(arr_delay ~ season, order = c("summer", "winter")) 
```


####Linear Model

Based on independent draws, statistic = coefficient (mean)


```{r}
lm(arr_delay ~ dep_delay, data = flights_samp) %>% 
  confint()
```


##Hypothesis Testing

###Bootstrap/Simulate/Permutate

####Proportion
```{r}
p_hat <- flights_samp %>%
  summarize(mean(day_hour == "morning")) %>%
  pull()

null_dist <- flights_samp %>%
   specify(response = day_hour, success = 'morning') %>%
   hypothesize(null = 'point', p = 0.5) %>%
   generate(reps = 1000, type = "simulate") %>%
   calculate(stat = "prop")

null_dist %>%
  ggplot(aes(x = stat)) + 
  geom_bar() +
  geom_vline(xintercept = p_hat, color = 'red')

null_dist %>%
  visualize(obs_stat = p_hat, direction = 'two_sided')

null_dist %>%
  summarize(p_value = mean(stat <= p_hat)*2)
```

####Mean
```{r}
x_bar <- flights_samp %>%
  summarize(mean(arr_delay)) %>%
  pull()

null_dist <- flights_samp %>%
   specify(response = arr_delay) %>%
   hypothesize(null = "point", mu = 10) %>%
   generate(reps = 1000, type = "bootstrap") %>%
   calculate(stat = "mean")

null_dist %>%
  ggplot(aes(x = stat)) + 
  geom_histogram() +
  geom_vline(xintercept = x_bar, color = 'red')

null_dist %>%
  visualize(obs_stat = x_bar, direction = 'two_sided')

null_dist %>%
  summarize(p_value = mean(stat >= x_bar)*2)
```

####Difference in Proportions

```{r}
d_hat <- flights_samp %>% 
  group_by(season) %>% 
  summarize(prop = mean(day_hour == "morning")) %>%
  # Since summer - winter
  summarize(-diff(prop)) %>%
  pull()

null_dist <- flights_samp %>%
  specify(day_hour ~ season, success = "morning") %>%
  hypothesize(null = 'independence') %>%
  generate(reps = 1000, type = "permute") %>% 
  calculate(stat = "diff in props", order = c("summer", "winter"))

null_dist %>%
  ggplot(aes(x = stat)) + 
  geom_histogram() +
  geom_vline(xintercept = d_hat, color = 'red')

null_dist %>%
  visualize(obs_stat = d_hat, direction = 'two_sided')

null_dist %>%
  summarize(p_value = mean(stat >= d_hat)*2)
```


####Difference in Means

```{r}
d_hat <- flights_samp %>% 
  group_by(season) %>% 
  summarize(mean_stat = mean(arr_delay)) %>% 
  # Want summer - winter
  summarize(-diff(mean_stat)) %>%
  pull()

null_dist <- flights_samp %>%
  specify(arr_delay ~ season) %>%
  hypothesize(null = 'independence') %>%
  generate(reps = 1000, type = "permute") %>%
  calculate(stat = "diff in means", order = c("summer", "winter")) 

null_dist %>%
  ggplot(aes(x = stat)) + 
  geom_histogram() +
  geom_vline(xintercept = d_hat, color = 'red')

null_dist %>%
  visualize(obs_stat = d_hat, direction = 'two_sided')

null_dist %>%
  summarize(p_value = mean(stat >= d_hat)*2)
```


####Linear Model

```{r}
slope_hat <- lm(arr_delay ~ dep_delay, data = flights_samp) %>% 
  broom::tidy() %>% 
  filter(term == "dep_delay") %>% 
  select(estimate) %>%
  pull()

null_dist <- flights_samp %>%
   specify(arr_delay ~ dep_delay) %>% 
   hypothesize(null = 'independence') %>%
   generate(reps = 1000, type = "permute") %>%
   calculate(stat = "slope")

null_dist %>%
  ggplot(aes(x = stat)) + 
  geom_histogram() +
  geom_vline(xintercept = slope_hat, color = 'red')

null_dist %>%
  visualize(obs_stat = slope_hat, direction = 'two_sided')

null_dist %>%
  summarize(p_value = mean(stat >= slope_hat)*2)
```



###Theory

####Proportion
```{r}

```

####Mean
```{r}
flights_samp %>%
  infer::t_test(arr_delay ~ NULL) 
```


####Difference in Proportions

```{r}
d_hat <- flights_samp %>% 
  group_by(season) %>% 
  summarize(prop = mean(day_hour == "morning")) %>%
  # Since summer - winter
  summarize(-diff(prop)) 

```


####Difference in Means

```{r}
flights_samp %>%
  mutate(season = factor(season)) %>%
  infer::t_test(arr_delay ~ season, order = c("summer", "winter")) 

obs_t <- flights_samp %>% 
  t_stat(formula = arr_delay ~season, order = c("summer", "winter"))

flights_samp %>%
   specify(arr_delay ~ season) %>%
   hypothesize(null = 'independence') %>%
   calculate(stat = "t", order = c("summer", "winter")) %>%
   visualize(method = 'theoretical', obs_stat = obs_t, direction = 'two_sided')
```


####Linear Model

```{r}
lm(arr_delay ~ dep_delay, data = flights_samp) %>% 
  confint()
```
